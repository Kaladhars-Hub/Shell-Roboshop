user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

# Add this inside the 'http' block, before your 'server' block
# This tells Nginx to use the AWS DNS server (172.31.0.2 is the default for a 172.31.0.0/16 VPC)
# It will re-check the DNS every 10 seconds.
resolver 172.31.0.2 valid=10s; 

# Define all your backend services as "upstreams"
upstream catalogue_service {
    server catalogue.awslearning.fun:8080;
}
upstream user_service {
    server user.awslearning.fun:8080;
}
upstream cart_service {
    server cart.awslearning.fun:8080;
}
upstream shipping_service {
    server shipping.awslearning.fun:8080;
}
upstream payment_service {
    server payment.awslearning.fun:8080;
}


# ... inside your 'http' block ...
server {
    listen       80;
    listen       [::]:80;
    server_name  _;
    root         /usr/share/nginx/html;

    # ... other locations ...

    # Now, proxy to your clean upstream names
    location /api/catalogue/ { proxy_pass http://catalogue_service/; }
    location /api/user/ { proxy_pass http://user_service/; }
    location /api/cart/ { proxy_pass http://cart_service/; }
    location /api/shipping/ { proxy_pass http://shipping_service/; }
    location /api/payment/ { proxy_pass http://payment_service/; }

    location /health {
      stub_status on;
      access_log off;
    }

    # ... other settings ...
}